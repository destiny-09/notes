
## IM系统架构
    1、客户端 -- APP、PC页面、桌面程序等
    2、接入服务 -- 连接保持、协议解析、Session维护、消息推送
    3、业务处理服务 -- 消息储存、消息同步、离线消息等
    
### 一般情况，IM系统接入层和业务层都是拆分开的：
    1、接入层要求HA，且变动不频繁，但是业务层可能会随着需求而经常变更和停机发版。
    2、接入层主要是面向Socket链接以及公共能力编码，业务层主要处理业务逻辑，有利于技术栈分开。
        
### IM系统特性
    1、实时性 -- 即时通讯，即时感知
    2、投递可靠性 -- 不丢消息、消息不重复
    3、时序一致性 -- 消息顺序一致性，时序基准（Redis的incr，DB的自增id，Twitter的snowflake），消息整流
    4、安全性 -- 数据传输安全、数据存储安全、消息内容安全等

### 消息存储
    1、内容表+索引表
    2、最近联系人表
    
    量级是多少？消息使用场景是写多读少还是读多写少？
    量级小的话存储用mysql就可以，量级大的话也可以考虑hbase。nio框架用netty就可以，离线缓存buffer可以用redis或者pika，
    未读数放redis的hash里就可以。手机端mqtt改造一下或者直接json也可以，浏览器端就websocket + json就行。

### 消息实时性
    1、短轮询 -- 实时性差，浪费客户端流量和电能、占用服务端带宽，服务器QPS压力大
    2、长轮询 -- 降低了QPS，但仍然存在“无效”请求，如：comet
    3、长连接 -- 真正的边缘触发，全双工通信，包括：WebSocket、XMPP、MQTT
    
    TCP长连接的方式是怎么实现“当有消息需要发送给某个用户时，能够准确找到这个用户对应的网络连接”？
        一种做法是用户上线时维护一个全局的 uid->网关机 的映射，下发的时候就能做到精确定位。
        另一种方式是：下发时把所有消息下发给所有机器，每台机器如果发现当前用户连接在本机就下发，其他的就丢掉，这种会有一定的资源浪费。
    
    客户端发送心跳包，一般多久一次比较合适？（微信用的是4分半）
        以前有大厂测试过国内各家运营商的NAT超时情况，有的运营商在2/3G网络下NAT超时是5分钟。
    


1、服务端路由中转
2、P2P


